name: ğŸš€ Production Release - Google Play & App Store

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ğŸ“± Version number (e.g., 1.3.0)'
        required: true
        type: string
      release_notes:
        description: 'ğŸ“ Release notes (what changed in this version)'
        required: true
        type: string
      deploy_android:
        description: 'ğŸ¤– Deploy to Google Play (Internal Testing)'
        required: true
        default: true
        type: boolean
      deploy_ios:
        description: 'ğŸ Deploy to TestFlight'
        required: true
        default: true
        type: boolean

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'
  RUBY_VERSION: '3.2'

jobs:
  # ============================================
  # Job 1: Version Bump
  # ============================================
  version-bump:
    name: ğŸ“ Update Version Numbers
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump.outputs.version }}
      android_version_code: ${{ steps.bump.outputs.android_version_code }}
      ios_build_number: ${{ steps.bump.outputs.ios_build_number }}
      commit_sha: ${{ steps.bump.outputs.commit_sha }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ğŸ”§ Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: âœ… Make Version Script Executable
        run: chmod +x scripts/update-app-version.sh
      
      - name: ğŸ”¢ Run Version Bump Script
        id: bump
        run: |
          # Generate iOS build number (timestamp)
          IOS_BUILD=$(date +%s)
          
          # Run version update script
          ./scripts/update-app-version.sh "${{ github.event.inputs.version }}" "$IOS_BUILD"
          
          # Extract updated Android version code
          ANDROID_CODE=$(grep 'versionCode' android/app/build.gradle | grep -oE '[0-9]+' | head -1)
          
          # Set outputs
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          echo "android_version_code=$ANDROID_CODE" >> $GITHUB_OUTPUT
          echo "ios_build_number=$IOS_BUILD" >> $GITHUB_OUTPUT
          
          echo "âœ… Version bumped successfully!"
          echo "ğŸ“± Version: ${{ github.event.inputs.version }}"
          echo "ğŸ¤– Android Version Code: $ANDROID_CODE"
          echo "ğŸ iOS Build Number: $IOS_BUILD"
      
      - name: ğŸ“Š Display Changes
        run: |
          echo "ğŸ“± Files Updated:"
          git diff --stat package.json app.json android/app/build.gradle ios/seraApp.xcodeproj/project.pbxproj
      
      - name: ğŸ’¾ Commit & Push Version Changes
        run: |
          git add package.json app.json android/app/build.gradle ios/seraApp.xcodeproj/project.pbxproj
          git commit -m "chore: release version ${{ github.event.inputs.version }}

          ğŸ“± Version: ${{ github.event.inputs.version }}
          ğŸ¤– Android Version Code: ${{ steps.bump.outputs.android_version_code }}
          ğŸ iOS Build Number: ${{ steps.bump.outputs.ios_build_number }}
          
          Release Notes:
          ${{ github.event.inputs.release_notes }}"
          
          git push origin main
          
          # Save commit SHA for later use
          echo "commit_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
      
      - name: ğŸ·ï¸ Create Git Tag
        run: |
          git tag -a "v${{ github.event.inputs.version }}" -m "Release v${{ github.event.inputs.version }}

          ${{ github.event.inputs.release_notes }}"
          
          git push origin "v${{ github.event.inputs.version }}"

  # ============================================
  # Job 2: Build Android AAB for Play Store
  # ============================================
  build-android:
    name: ğŸ¤– Build Android Release AAB
    needs: version-bump
    runs-on: ubuntu-latest
    environment: PROD
    if: github.event.inputs.deploy_android == 'true'
    timeout-minutes: 45
    
    steps:
      - name: ğŸ“¥ Checkout Code (versioned)
        uses: actions/checkout@v4
        with:
          ref: v${{ needs.version-bump.outputs.version }}
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: â˜• Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'
      
      - name: ğŸ”„ Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      - name: ğŸ“¦ Install NPM Dependencies
        run: npm ci --legacy-peer-deps
      
      - name: ğŸ”‘ Decode Android Upload Keystore
        run: |
          echo "${{ secrets.ANDROID_UPLOAD_KEYSTORE_BASE64 }}" | base64 -d > android/app/upload.keystore
          echo "âœ… Upload keystore decoded successfully"
      
      - name: ğŸ”§ Make Gradlew Executable
        run: chmod +x android/gradlew
      
      - name: ğŸ“‹ Check Android Environment
        run: |
          echo "ğŸ” Android Environment Check:"
          echo "â€¢ Keystore file exists: $(ls -la android/app/upload.keystore 2>/dev/null && echo 'YES' || echo 'NO')"
          echo "â€¢ Gradle wrapper exists: $(ls -la android/gradlew 2>/dev/null && echo 'YES' || echo 'NO')"
          echo "â€¢ Environment variables:"
          echo "  - KEYSTORE_PASSWORD: ${KEYSTORE_PASSWORD:+SET}"
          echo "  - KEY_ALIAS: ${KEY_ALIAS:+SET}"
          echo "  - KEY_PASSWORD: ${KEY_PASSWORD:+SET}"
      
      - name: ğŸ—ï¸ Build Android Release AAB (Signed with Upload Key)
        working-directory: android
        env:
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_UPLOAD_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_UPLOAD_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_UPLOAD_KEY_PASSWORD }}
        run: |
          # Set Gradle JVM options for better memory management
          export GRADLE_OPTS="-Xmx4g -XX:MaxMetaspaceSize=1g -XX:+HeapDumpOnOutOfMemoryError"
          
          # Clean before build
          ./gradlew clean
          
          # Build with detailed logging
          ./gradlew bundleRelease \
            --no-daemon \
            --stacktrace \
            --info \
            --max-workers=2
          
          echo "âœ… AAB signed with upload key and ready for Google Play!"
      
      - name: ğŸ“¦ Verify AAB File
        run: |
          if [ -f "android/app/build/outputs/bundle/release/app-release.aab" ]; then
            echo "âœ… AAB file found!"
            ls -lh android/app/build/outputs/bundle/release/app-release.aab
          else
            echo "âŒ AAB file not found!"
            exit 1
          fi
      
      - name: â¬†ï¸ Upload AAB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sera-android-aab-v${{ needs.version-bump.outputs.version }}
          path: android/app/build/outputs/bundle/release/app-release.aab
          retention-days: 90
      
      - name: â¬†ï¸ Upload Mapping File (for crash reports)
        uses: actions/upload-artifact@v4
        with:
          name: sera-android-mapping-v${{ needs.version-bump.outputs.version }}
          path: android/app/build/outputs/mapping/release/mapping.txt
          retention-days: 365
          if-no-files-found: ignore

  # ============================================
  # Job 3: Deploy to Google Play Internal Testing
  # ============================================
  deploy-android:
    name: ğŸš€ Deploy to Google Play (Internal Testing)
    needs: [version-bump, build-android]
    runs-on: ubuntu-latest
    environment: PROD
    
    steps:
      - name: ğŸ“¥ Download AAB Artifact
        uses: actions/download-artifact@v4
        with:
          name: sera-android-aab-v${{ needs.version-bump.outputs.version }}
          path: ./artifacts
      
      - name: ğŸ“‹ Verify Downloaded AAB
        run: |
          echo "ğŸ“¦ Downloaded AAB:"
          ls -lh ./artifacts/
          
          # Create release notes directory if it doesn't exist
          mkdir -p android/release-notes/
          echo "Release v${{ needs.version-bump.outputs.version }}" > android/release-notes/whatsnew-en-US.txt
          echo "Ø¥ØµØ¯Ø§Ø± v${{ needs.version-bump.outputs.version }}" > android/release-notes/whatsnew-ar.txt
          
          echo "âœ… Release notes created"
      
      - name: ğŸš€ Deploy to Google Play Console (Internal Testing)
        uses: r0adkll/upload-google-play@v1.1.3
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.sera.seraapp
          releaseFiles: ./artifacts/app-release.aab
          track: internal
          status: completed
          inAppUpdatePriority: 2
          whatsNewDirectory: android/release-notes/
          releaseName: v${{ needs.version-bump.outputs.version }}
      
      - name: âœ… Android Deployment Complete
        run: |
          echo "âœ… Successfully deployed to Google Play Internal Testing!"
          echo "ğŸ“± Version: ${{ needs.version-bump.outputs.version }}"
          echo "ğŸ”¢ Version Code: ${{ needs.version-bump.outputs.android_version_code }}"
          echo "ğŸ”— Check: https://play.google.com/console"

  # ============================================
  # Job 4: Build iOS IPA for TestFlight
  # ============================================
  build-ios:
    name: ğŸ Build iOS Release IPA
    needs: version-bump
    runs-on: macos-14
    environment: PROD
    if: github.event.inputs.deploy_ios == 'true'
    timeout-minutes: 60
    
    steps:
      - name: ğŸ“¥ Checkout Code (versioned)
        uses: actions/checkout@v4
        with:
          ref: v${{ needs.version-bump.outputs.version }}
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ’ Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
          working-directory: ios
      
      - name: ğŸ”„ Cache CocoaPods (Disabled for Clean Build)
        run: |
          echo "âš ï¸ Skipping CocoaPods cache to ensure clean build"
          echo "This prevents hermes-engine version conflicts"
      
      - name: ğŸ“¦ Install NPM Dependencies
        run: npm ci --legacy-peer-deps
      
      - name: ğŸ Install CocoaPods Dependencies
        run: |
          cd ios
          
          # Clean existing pods to avoid conflicts
          rm -rf Pods Podfile.lock
          
          # Set CocoaPods environment variables for better performance
          export COCOAPODS_DISABLE_STATS=true
          export COCOAPODS_SKIP_CACHE=false
          
          # Install pods with specific hermes-engine update
          pod install --repo-update --verbose --no-ansi
          
          # If hermes-engine conflict persists, force update it
          pod update hermes-engine --no-repo-update || true
          
          # Verify hermes-engine installation (simplified check)
          echo "ğŸ” Verifying hermes-engine installation..."
          if [ -d "Pods/hermes-engine" ]; then
            echo "âœ… hermes-engine directory found"
          else
            echo "âš ï¸ hermes-engine directory not found, but continuing..."
          fi
          
          echo "âœ… CocoaPods installed successfully"
      
      - name: ğŸ” Import iOS Code Signing Certificates
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.IOS_CERTIFICATE_P12_BASE64 }}
          p12-password: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
      
      - name: ğŸ“„ Install iOS Provisioning Profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}" | base64 -d > ~/Library/MobileDevice/Provisioning\ Profiles/${{ secrets.IOS_PROVISIONING_PROFILE_NAME }}.mobileprovision
          echo "âœ… Provisioning profile installed"
      
      - name: ğŸ—ï¸ Build iOS Archive
        run: |
          xcodebuild archive \
            -workspace ios/seraApp.xcworkspace \
            -scheme seraApp \
            -configuration Release \
            -archivePath ios/build/seraApp.xcarchive \
            -destination 'generic/platform=iOS' \
            -allowProvisioningUpdates \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM=${{ secrets.IOS_TEAM_ID }} \
            PROVISIONING_PROFILE_SPECIFIER="${{ secrets.IOS_PROVISIONING_PROFILE_NAME }}" \
            CODE_SIGN_IDENTITY="Apple Distribution"
          
          echo "âœ… iOS archive created successfully!"
      
      - name: ğŸ“¦ Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath ios/build/seraApp.xcarchive \
            -exportPath ios/build \
            -exportOptionsPlist ios/ExportOptions-Release.plist \
            -allowProvisioningUpdates
          
          echo "âœ… IPA exported successfully!"
      
      - name: ğŸ“‹ Verify IPA File
        run: |
          if [ -f "ios/build/seraApp.ipa" ]; then
            echo "âœ… IPA file found!"
            ls -lh ios/build/seraApp.ipa
          else
            echo "âŒ IPA file not found!"
            exit 1
          fi
      
      - name: â¬†ï¸ Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sera-ios-ipa-v${{ needs.version-bump.outputs.version }}
          path: ios/build/seraApp.ipa
          retention-days: 90
      
      - name: â¬†ï¸ Upload dSYM Files (for crash reports)
        uses: actions/upload-artifact@v4
        with:
          name: sera-ios-dsym-v${{ needs.version-bump.outputs.version }}
          path: ios/build/seraApp.xcarchive/dSYMs/
          retention-days: 365
          if-no-files-found: ignore

  # ============================================
  # Job 5: Deploy to TestFlight
  # ============================================
  deploy-ios:
    name: ğŸš€ Deploy to TestFlight
    needs: [version-bump, build-ios]
    runs-on: macos-14
    environment: PROD
    
    steps:
      - name: ğŸ“¥ Download IPA Artifact
        uses: actions/download-artifact@v4
        with:
          name: sera-ios-ipa-v${{ needs.version-bump.outputs.version }}
          path: ./artifacts
      
      - name: ğŸ“‹ Verify Downloaded IPA
        run: |
          echo "ğŸ“¦ Downloaded IPA:"
          ls -lh ./artifacts/
      
      - name: ğŸš€ Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: ./artifacts/seraApp.ipa
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}
      
      - name: âœ… iOS Deployment Complete
        run: |
          echo "âœ… Successfully uploaded to TestFlight!"
          echo "ğŸ“± Version: ${{ needs.version-bump.outputs.version }}"
          echo "ğŸ”¢ Build Number: ${{ needs.version-bump.outputs.ios_build_number }}"
          echo "ğŸ”— Check: https://appstoreconnect.apple.com"

  # ============================================
  # Job 6: Create GitHub Release
  # ============================================
  create-release:
    name: ğŸ“¦ Create GitHub Release
    needs: [version-bump, build-android, build-ios]
    runs-on: ubuntu-latest
    if: always() && (needs.build-android.result == 'success' || needs.build-ios.result == 'success')
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          ref: v${{ needs.version-bump.outputs.version }}
      
      - name: ğŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./release-artifacts
      
      - name: ğŸ“‹ List All Artifacts
        run: |
          echo "ğŸ“¦ Release Artifacts:"
          find ./release-artifacts -type f -exec ls -lh {} \;
      
      - name: ğŸ“¦ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.version-bump.outputs.version }}
          name: ğŸš€ SERA Mobile v${{ needs.version-bump.outputs.version }}
          body: |
            ## ğŸ“± SERA Mobile App - Version ${{ needs.version-bump.outputs.version }}
            
            ### âœ¨ What's New
            ${{ github.event.inputs.release_notes }}
            
            ---
            
            ### ğŸ“Š Build Information
            | Platform | Status | Details |
            |----------|--------|---------|
            | ğŸ¤– Android | ${{ needs.build-android.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} | Version Code: `${{ needs.version-bump.outputs.android_version_code }}` |
            | ğŸ iOS | ${{ needs.build-ios.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} | Build Number: `${{ needs.version-bump.outputs.ios_build_number }}` |
            
            ### ğŸ“¦ Downloads
            - **Android AAB**: `sera-android-aab-v${{ needs.version-bump.outputs.version }}.zip`
            - **iOS IPA**: `sera-ios-ipa-v${{ needs.version-bump.outputs.version }}.zip`
            - **Android Mapping**: Crash reports deobfuscation file
            - **iOS dSYM**: Crash reports symbolication files
            
            ### ğŸš€ Deployment Status
            - ğŸ¤– **Google Play (Internal Testing)**: ${{ needs.deploy-android.result == 'success' && 'âœ… Deployed' || github.event.inputs.deploy_android == 'true' && 'â³ In Progress' || 'â­ï¸ Skipped' }}
            - ğŸ **TestFlight**: ${{ needs.deploy-ios.result == 'success' && 'âœ… Deployed' || github.event.inputs.deploy_ios == 'true' && 'â³ In Progress' || 'â­ï¸ Skipped' }}
            
            ### ğŸ“… Release Details
            - **Release Date**: ${{ github.event.head_commit.timestamp }}
            - **Commit SHA**: `${{ needs.version-bump.outputs.commit_sha }}`
            - **Workflow Run**: [View Build](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ### ğŸ”— Store Links
            - [Google Play Console](https://play.google.com/console)
            - [App Store Connect](https://appstoreconnect.apple.com)
            
            ---
            
            ### ğŸ“ Notes
            - Internal testers will receive automatic notifications
            - Review times: ~1-2 days for Google Play, ~1-2 days for TestFlight
            - Crash reports will be automatically symbolicated with uploaded mapping/dSYM files
          files: |
            ./release-artifacts/**/*
          draft: false
          prerelease: false
          generate_release_notes: true

  # ============================================
  # Job 7: Post-Deployment Notifications
  # ============================================
  notify:
    name: ğŸ“¢ Send Deployment Notifications
    needs: [version-bump, build-android, build-ios, deploy-android, deploy-ios]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Deployment Summary
        run: |
          echo "## ğŸš€ SERA Mobile Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“± Version Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.version-bump.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Android Version Code**: ${{ needs.version-bump.outputs.android_version_code }}" >> $GITHUB_STEP_SUMMARY
          echo "- **iOS Build Number**: ${{ needs.version-bump.outputs.ios_build_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Build Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version Bump | ${{ needs.version-bump.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Android | ${{ needs.build-android.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build iOS | ${{ needs.build-ios.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Android | ${{ needs.deploy-android.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy iOS | ${{ needs.deploy-ios.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ Release Notes" >> $GITHUB_STEP_SUMMARY
          echo "${{ github.event.inputs.release_notes }}" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ’¬ Send Slack Notification (if configured)
        if: always()
        continue-on-error: true
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ğŸš€ *SERA Mobile Release v${{ needs.version-bump.outputs.version }}*
            
            *Build Status:*
            â€¢ Android AAB: ${{ needs.build-android.result == 'success' && 'âœ…' || 'âŒ' }}
            â€¢ iOS IPA: ${{ needs.build-ios.result == 'success' && 'âœ…' || 'âŒ' }}
            
            *Deployment Status:*
            â€¢ Google Play: ${{ needs.deploy-android.result == 'success' && 'âœ… Deployed' || 'âŒ Failed' }}
            â€¢ TestFlight: ${{ needs.deploy-ios.result == 'success' && 'âœ… Deployed' || 'âŒ Failed' }}
            
            *What's New:*
            ${{ github.event.inputs.release_notes }}
            
            Triggered by: @${{ github.actor }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

# Required permissions
permissions:
  contents: write      # Create releases and tags
  actions: write       # Trigger workflows
  packages: read       # Read packages
