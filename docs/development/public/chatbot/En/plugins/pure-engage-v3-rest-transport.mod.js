/*!
 * widgets
 * @version: 9.0.017.00
 * @license: Genesys Telecom Labs
 */
widgetsJsonpFunction([19],{"./webapp/plugins/cx-webchat-service/transports/pure-engage-v3-rest-transport.js":function(e,t,s){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}var n=function(){function e(e,t){for(var s=0;s<t.length;s++){var o=t[s];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,s,o){return s&&e(t.prototype,s),o&&e(t,o),t}}(),i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var o in s)Object.prototype.hasOwnProperty.call(s,o)&&(e[o]=s[o])}return e},r=o(s("./node_modules/jquery/dist/jquery.js")),l=o(s("./webapp/plugins/cx-common/cx-common.js")),u=o(s("./node_modules/js-cookie/src/js.cookie.js")),c={init:function(e){c.transport=e},getSanitizedIndex:function(e){var t=e;return t&&(t=t.replace("-","")),t},updateSessionCookies:function(){var e=c.transport,t=e.oSessionData,s=c.transport,o=s.bAsyncMode,n=s.getSessionData;o&&"function"==typeof n?c.updateCustomerToken():l.default.setCookie(e.sCookie_Keys,t.token),l.default.setCookie(e.sCookie_Session,t.sessionId)},removeCookies:function(){var e=c.transport;l.default.deleteCookie(e.sCookie_Session),l.default.deleteCookie(e.sCookie_Keys),l.default.deleteCookie(e.sCookie_Index)},getSessionFromCookie:function(){var e=c.transport;e.oSessionData=l.default.decodeJWTToken(l.default.getCookie(e.sCookie_Keys))},getHeaders:function(){var e=c.transport,t=e.sCookie_Keys,s=e.oConfig,o={};if(e.bAsyncMode&&"function"==typeof c.getCustomerToken){var n=c.getCustomerToken().token;o=a({},s.oHeaders,{"x-nexus-client-key":n})}else o=a({},s.oHeaders,{"x-nexus-client-key":l.default.getCookie(t)});return o},transformMessage:function(e){var t=e.from;if(t){var s=t.nickname,o=t.type,n=t.participantId;s&&(e.from.name=s),o&&"Customer"==o&&(e.from.type="Client"),n&&(e.from.id=n)}return e},parseMessageForEvents:function(e){var t=c.transport,s=e.type,o=e.from.type,n=e.from.participantId,i={};if(e=c.transformMessage(e),"Message"!=s&&"PushUrl"!=s&&"Notice"!=s||"Agent"!=o&&"Supervisor"!=o||t.onAgentTypingStopped(e),"ParticipantJoined"==s)switch("Agent"!=o&&"Supervisor"!=o||(t.oAgents[n]={name:e.from.name,connected:!0,supervisor:"Supervisor"==o,connectedTime:e.timestamp,disconnectedTime:!1}),i={message:e,agents:t.oAgents},o){case"Client":t.onClientConnected(i);break;case"Agent":t.onAgentConnected(i);break;case"Supervisor":t.onSuperVisorConnected(i)}else if("ParticipantLeft"==s)switch(t.oAgents[n]&&(t.oAgents[n].connected=!1,t.oAgents[n].disconnectedTime=e.timestamp),i={message:e,agents:t.oAgents},o){case"Client":t.onClientDisconnected(i);break;case"Agent":t.onAgentDisconnected(i),t.onAgentTypingStopped(i);break;case"Supervisor":t.onSuperVisorDisconnected(i)}"Agent"!=o&&"Supervisor"!=o||("TypingStarted"==s&&(t.onAgentTypingStarted(e),t.bAgentTypingTimerActive||(t.bAgentTypingTimerActive=!0,setTimeout((function(){t.bAgentTypingTimerActive=!1,t.onAgentTypingTimeout()}),t.iAgentTypingTimer))),"TypingStopped"==s&&t.onAgentTypingStopped(e))},setPreviousIndex:function(e){if(e.length){var t=c.transport;1==e.length&&e[0].index==t.previousStartIndex?(t.bAllMessagesReceived=!0,t.continuePoll(),t.onMessageReceived({data:{}})):(t.bAllMessagesReceived=!1,t.previousStartIndex=e[0].index)}},formatMessages:function(e){var t=[],s=[],o=[],n=c.transport,i=r.default.Deferred();return r.default.each(e||[],(function(){var e=this,i={},u=c.getSanitizedIndex(e.index),d=r.default.Deferred();if(e.iTempIndex=u,c.checkChatIndexHash(u)){if(o.push(e),(i=a({},e)).timestamp=i.utcTime,i.index=u,i.type="Text"==i.type?"Message":i.type,"PushUrl"==i.type&&i.url&&(i.text=i.url),i.from){var p=e.from;i.from={name:p.nickname||p.firstName,type:"Customer"==p.type?"Client":p.type,participantId:p.participantId}}i.content&&i.content.length?(t.push(d),c.getFileContents(i.content).done((function(t){i.content=t,c.parseMessageForEvents(e),n.index=u,n.originalIndex=e.index,l.default.setCookie(n.sCookie_Index,u),n.bAsyncMode&&"function"==typeof n.getSessionData&&c.updateCustomerToken(),s.push(i),d.resolve({aMessages:s,aUniqueOriginalMessages:o})}))):(c.parseMessageForEvents(e),n.index=u,n.originalIndex=e.index,l.default.setCookie(n.sCookie_Index,u),n.bAsyncMode&&"function"==typeof n.getSessionData&&c.updateCustomerToken(),s.push(i),d.resolve({aMessages:s,aUniqueOriginalMessages:o}),t.push(d))}else d.resolve(),t.push(d)})),r.default.when.apply(void 0,t).then((function(){s?i.resolve({aMessages:s,aUniqueOriginalMessages:o}):i.reject()})),i.promise()},parseTranscript:function(e,t){var s=c.transport;(t&&"restore"==t.type||t&&"fetchHistory"==t.type)&&c.setPreviousIndex(e,t),Object.keys(e).length&&c.formatMessages(e).done((function(e){var o=e.aMessages,n=e.aUniqueOriginalMessages;o&&o.length>0&&(t&&t.type&&("restore"==t.type&&o.sort((function(e,t){return e.index-t.index})),"fetchHistory"==t.type&&(o.sort((function(e,t){return t.index-e.index})),n&&n.length>0&&(n.sort((function(e,t){return t.iTempIndex-e.iTempIndex})),n=n.map((function(e){return delete e.iTempIndex,e}))))),s.onMessageReceived({data:{originalMessages:n,messages:o,restoring:s.bRestoring,oldMessages:s.bFetchOldAsyncMessages&&t&&"fetchHistory"==t.type}}),s.bPausePoll&&s.bFetchOldAsyncMessages&&t&&"fetchHistory"==t.type&&s.continuePoll())}))},refresh:function(e){if(e.data){var t=e.data,s=c.transport;1==t.chatEnded&&1==s.bSessionActive&&c.terminateChatSession(),t.messages&&!s.bPausePoll&&c.parseTranscript(t.messages)}},restore:function(e,t){var s=c.transport;if(e.data){var o=e.data;return s.bSessionActive=!0,localStorage.setItem(s.sLocalStgPollPending,"false"),s.onRestore({async:!(!s.bAsyncMode&&!t)}),o.messages&&c.parseTranscript(o.messages,{type:"restore"}),s.bRestoring=!1,s.bFetchOldAsyncMessages=!1,s.startPoll(),!0}return!1},getFormData:function(e){var t=c.transport.oConfig,s=l.default.getBrowserandOS(),o={_genesys_source:l.default.isMobileDevice()?"mobile":"web",_genesys_referrer:document.referrer,_genesys_url:document.location.href,_genesys_pageTitle:document.title,_genesys_browser:s.browser,_genesys_OS:s.os},n=a({},t.oUserData,o),r={endpoint:t.sEndpoint,userData:n};if(t.sClientType&&(r.clientType=t.sClientType),e){var u=e.firstname,d=e.lastname,p=e.nickname,g=function(e,t){var s={};for(var o in e)t.indexOf(o)>=0||Object.prototype.hasOwnProperty.call(e,o)&&(s[o]=e[o]);return s}(e,["firstname","lastname","nickname"]);return"object"==i(e.userData)&&(r.userData=a({},r.userData,e.userData)),t.sTransportStream&&(g.stream=t.sTransportStream),a({firstName:u,lastName:d,nickname:p||u||e.firstName},r,g)}return r},terminateChatSession:function(){var e=c.transport;c.removeCookies(),e.stopPoll(),e.bSessionActive=!1,c.reset()},checkChatIndexHash:function(e){var t=c.transport;return e=c.getSanitizedIndex(e),!t.oChatIndexHash[e]&&(t.oChatIndexHash[e]=!0,!0)},reset:function(){var e=c.transport;e.oChatIndexHash={},e.oAgents={},e.oSessionData={},e.previousStartIndex=0,e.bAllMessagesReceived=!1},sendRequest:function(e){var t=r.default.Deferred(),s=c.transport,o=s.oSessionData.sessionId,n=s.oConfig;return l.default.request({url:n.sServerURL+"/"+o+"/messages",type:"POST",crossDomain:!0,headers:c.getHeaders(),data:{operationId:l.default.guid(),data:{type:e.type||"Text",text:e.message||""}},timeout:n.iAjaxTimeout,success:function(e){return t.resolve(e)},error:function(e){return t.reject(e)}}),t.promise()},getFileContents:function(e){var t=c.transport.oConfig.sServerURL,s=c.transport.oConfig,o=[],n=t.replace("/sessions",""),i=[];return r.default.each(e,(function(e,t){var a=new r.default.Deferred;t.mime&&t.url&&(t.url=n+t.url),t.type&&"image"==t.type?l.default.getImageFromURL({url:t.url,headers:c.getHeaders(),ajaxTimeout:s.iAjaxTimeout}).done((function(e){e&&(t.url=e.base64Data,o.push(t),a.resolve(o))})).fail((function(e){a.reject(e)})):(o.push(t),a.resolve(o)),i.push(a)})),r.default.when.apply(void 0,i).promise()},handleSessionLost:function(e){var t=c.transport;t.bFetchOldAsyncMessages=!1,t.deleteSessionData&&(t.deleteSessionData({sessionData:t.oSessionData,response:e},u.default,l.default.getCookieOptions()),t.bRestoring=!1),t.onSessionLost(e),t.onError(e),c.terminateChatSession(),localStorage.setItem(t.sLocalStgPollPending,"false")},handleError:function(e){var t=c.transport,s=e&&(e.responseJSON||e.responseText&&JSON.parse(e.responseText)||{}),o=void 0,n=void 0;if(s){var i=s.status;i&&(o=i.message||"",n=i.code||"")}"INVALID_SESSION"==n||e&&404==e.status||t.bAsyncMode&&t.bRestoring&&e&&401==e.status?c.handleSessionLost(e):t.onError({code:1!==n?t.errorPrefix+n:"",text:o||"",response:e})},disconnected:function(){var e=c.transport;e.bDisconnected=!0,e.onDisconnected()},reconnected:function(){var e=c.transport;e.bDisconnected=!1,e.onReconnected()},updateCustomerToken:function(){var e=c.transport,t=e.oSessionData,s=c.transport.getSessionData;t.token&&s({messageIndex:e.index,token:t.token},u.default,l.default.getCookieOptions())},getCustomerToken:function(){var e=c.transport,t=e.setSessionData,s=e.sCookie_open,o=e.capabilities;c.transport.onCapabilitiesChanged(o);var n=t(s,u.default,l.default.getCookieOptions());return"undefined"!==n&&n&&"string"==typeof n&&n.length>0?n=JSON.parse(n):!(!n||"object"!=(void 0===n?"undefined":i(n))||!Object.keys(n).length)&&n}},d=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.oConfig=t,this.bDisconnected=!1;var s="."+t.transport.type;if(this.oAgents={},this.bSessionActive=!1,this.oSessionData={},this.sCookie_Session=t.sCookie_Prefix+s+".session",this.sCookie_Keys=t.sCookie_Prefix+s+".keys",this.sCookie_Index=t.sCookie_Prefix+s+".index",this.sCookie_open=t.sCookie_Prefix+s+".open",this.fPollTimeout=!1,this.bPausePoll=!1,this.sLocalStgPollPending="_genesys.widgets.chatPollPending",this.bPolling=!1,this.bPollingPending=!1,localStorage.setItem(this.sLocalStgPollPending,localStorage.getItem(this.sLocalStgPollPending)||"false"),this.oPollAjax=!1,this.bPollError=!1,this.iPollIntervalMultiplier=1.2,this.iAgentTypingTimer=3e3,this.bAgentTypingTimerActive=!1,this.onChatStarted=this.onChatStarted.bind(this),this.onMessageReceived=this.onMessageReceived.bind(this),this.onRestore=this.onRestore.bind(this),this.onPollingStarted=this.onPollingStarted.bind(this),this.onError=this.onError.bind(this),this.bRestoring=!1,this.oChatIndexHash={},this.previousStartIndex=0,this.maxMessagePageSize=20,this.index=0,this.originalIndex=0,this.bAllMessagesReceived=!1,this.bAsyncMode=!1,this.getSessionData=!1,this.setSessionData=!1,this.deleteSessionData=!1,this.bStartNewAsyncChat=!1,this.bFetchOldAsyncMessages=!1,this.errorPrefix=t.transport.type+"-",this.oMapping={"userData.phone":{target:"userData.PhoneNumber",type:"string"}},"object"==i(t.transport)){var o=t.transport,n="function",a="string",r="number",l=this.oConfig;if(i(o.dataURL)==a&&(l.sServerURL=o.dataURL),"object"==i(o.headers)&&(l.oHeaders=o.headers),i(o.endpoint)==a&&(l.sEndpoint=o.endpoint),i(o.clientType)==a&&(l.sClientType=o.clientType),i(o.pollTimeout)==r&&(l.pollTimeout=o.pollTimeout),i(o.stream)==a&&(l.sTransportStream=o.stream),i(o.pollExceptionLimit)==r&&(l.iPollExceptionLimit=o.pollExceptionLimit),i(o.maxMessagePageSize)==r&&(this.maxMessagePageSize=o.maxMessagePageSize),i(o.pollIntervalMultiplier)==r&&(this.iPollIntervalMultiplier=o.pollIntervalMultiplier),this.maxMessagePageSize<16&&(this.maxMessagePageSize=16),"object"==i(o.async)){var u=o.async;"boolean"==i(u.enabled)&&(this.bAsyncMode=u.enabled),i(u.setSessionData)==n&&i(u.getSessionData)==n&&(this.setSessionData=u.setSessionData,this.getSessionData=u.getSessionData),u.deleteSessionData&&i(u.deleteSessionData)==n&&(this.deleteSessionData=u.deleteSessionData)}}this.capabilities={async:this.bAsyncMode,asyncClose:"endChat",pagination:!0},this.iPollTimeout_ms=this.oConfig.pollTimeout||3e3,this.iPollTimeout_ms<100&&(this.iPollTimeout_ms=100),this.iIncrementalPollTimeout_ms=this.iPollTimeout_ms,t.iAjaxTimeout=t.iAjaxTimeout||9e3,this.onCapabilitiesChanged(this.capabilities),c.init(this)}return n(e,[{key:"onChatStarted",value:function(e,t){}},{key:"onTypingStarted",value:function(e){}},{key:"onTypingStopped",value:function(e){}},{key:"onMessageReceived",value:function(e){}},{key:"onChatEnded",value:function(e){}},{key:"onError",value:function(e){}},{key:"onRestore",value:function(e){}},{key:"onReconnected",value:function(){}},{key:"onDisconnected",value:function(){}},{key:"onRestoreFailed",value:function(e){}},{key:"onSessionLost",value:function(e){}},{key:"onPollingStarted",value:function(){}},{key:"onPollingStopped",value:function(){}},{key:"onCapabilitiesChanged",value:function(e){}},{key:"onSleep",value:function(){}},{key:"onWake",value:function(){}},{key:"startChat",value:function(e){var t=r.default.Deferred(),s=this.oConfig,o=c.getFormData(e.form),n=s.oHeaders,i=this;if("boolean"==e.async&&(this.bAsyncMode=e.async),e.headers&&(s.oHeaders=e.headers),this.bAsyncMode&&"function"==typeof this.setSessionData){var a=c.getCustomerToken().token;a&&(n["x-nexus-client-key"]=a)}return o.userData=r.default.extend({},o.userData,e.userData||{},!0),o.userData&&(o=l.default.mapProperties(i.oMapping,{userData:o.userData},o)),l.default.request({url:e.dataURL||s.sServerURL,type:"POST",crossDomain:!0,headers:e.headers||n,data:{data:o,operationId:l.default.guid()},timeout:s.iAjaxTimeout,success:function(e){if(e.data&&e.data.clientToken){var s=e.data;i.bSessionActive=!0,i.oSessionData=l.default.decodeJWTToken(s.clientToken),i.oSessionData.token=s.clientToken,c.updateSessionCookies(),i.onChatStarted({data:i.oSessionData},e),i.startPoll(),t.resolve(e)}else t.reject(e),i.onError(e)},error:function(e){t.reject(e||{}),c.handleError(e)}}),t.promise()}},{key:"startPoll",value:function(){this.bPolling=!0,this.bFetchOldAsyncMessages=!1,this.poll()}},{key:"stopPoll",value:function(){var e=r.default.Deferred();return localStorage.setItem(this.sLocalStgPollPending,"false"),this.fPollTimeout?(this.bPolling&&(this.bPolling=!1,clearTimeout(this.fPollTimeout),this.fPollTimeout=!1,this.bPollError=!1,this.iIncrementalPollTimeout_ms=this.iPollTimeout_ms,this.onPollingStopped(),e.resolve()),e.promise()):(e.reject("Not currently polling. Ignoring command."),e.promise())}},{key:"continuePoll",value:function(){this.bPausePoll&&(this.bPolling=!0,this.bPausePoll=!1,this.bFetchOldAsyncMessages=!1,localStorage.setItem(this.sLocalStgPollPending,"false"),this.poll(this.originalIndex),this.onWake())}},{key:"pausePoll",value:function(){this.bPolling=!1,this.bPausePoll=!0,clearTimeout(this.fPollTimeout),this.fPollTimeout=!1,this.bPollError=!1,this.iIncrementalPollTimeout_ms=this.iPollTimeout_ms,this.bPollingPending&&this.oPollAjax&&(localStorage.setItem(this.sLocalStgPollPending,"false"),this.oPollAjax.abort()),this.onSleep()}},{key:"_longPoll",value:function(){var e=this;this.bPolling&&(this.bFetchOldAsyncMessages=!1,this.bPollError?this.iIncrementalPollTimeout_ms=parseInt(this.iIncrementalPollTimeout_ms*this.iPollIntervalMultiplier):this.iIncrementalPollTimeout_ms=this.iPollTimeout_ms,this.fPollTimeout=setTimeout(function(){e.bPausePoll||this.poll()}.bind(this),this.iIncrementalPollTimeout_ms))}},{key:"poll",value:function(e){var t=this,s="",o=r.default.Deferred(),n=this.oSessionData.sessionId,i=localStorage.getItem(this.sLocalStgPollPending);if(this.bFetchOldAsyncMessages=!1,!t.bSessionActive)return o.reject("There is no active chat session"),!1;if(!n||this.bPollingPending||"false"!=i||t.bPausePoll)o.reject("previous poll has not finished.");else{var a=this.oConfig;this.bPollingPending=!0,localStorage.setItem(t.sLocalStgPollPending,"true"),this.onPollingStarted(),s=e?a.sServerURL+"/"+n+"/messages?operationId="+l.default.guid()+"&index="+e:a.sServerURL+"/"+n+"/messages?operationId="+l.default.guid(),this.oPollAjax=l.default.request({url:s,type:"GET",crossDomain:!0,headers:c.getHeaders(),success:function(e){t.bPollError=!1,t.bPollingPending=!1,localStorage.setItem(t.sLocalStgPollPending,"false"),t.oPollAjax=!1,c.refresh(e),t.bPausePoll||t._longPoll(),t.bDisconnected&&c.reconnected(),o.resolve()},error:function(e){t.bPollingPending=!1,localStorage.setItem(t.sLocalStgPollPending,"false"),t.oPollAjax=!1,t.bPausePoll||(e&&0==e.status&&!t.bDisconnected?c.disconnected():t.bDisconnected||c.handleError(e),429!==e.status&&(t.bPollError=!0),t._longPoll()),o.reject()}})}return o.promise()}},{key:"sendMessage",value:function(e){var t=r.default.Deferred(),s=this;return this.bFetchOldAsyncMessages=!1,this.bDisconnected?(t.resolve({statusCode:1}),!1):(this.bSessionActive?("text"==e.type&&(e.type="Text"),c.sendRequest(e).done((function(e){1==e.chatEnded&&1==s.bSessionActive&&c.terminateChatSession(),t.resolve(e)})).fail((function(e){s.onError(e),t.reject()}))):t.reject("There is no active chat session."),t.promise())}},{key:"sendFile",value:function(e){var t=r.default.Deferred();if(this.bFetchOldAsyncMessages=!1,this.bSessionActive){var s=e.data.files.files[0];if(l.default.isFeatureSupported("FormData")){var o=new FormData,n=this.oSessionData.sessionId,i=this.oConfig.sServerURL;s&&o.append("file",s),o.append("operationId",l.default.guid()),l.default.request({url:i+"/"+n+"/images",type:"POST",crossDomain:!0,mimeType:"multipart/form-data",contentType:!1,processData:!1,headers:c.getHeaders(),data:o,success:function(e){t.resolve(e)},error:function(e){c.handleError(e),t.reject(e)}})}else t.reject("Sorry, cannot send attachments. HTMl5 FormData is not support on your browser")}else t.reject("There is no active chat session.");return t.promise()}},{key:"sendTyping",value:function(e){var t=r.default.Deferred(),s=this;return this.bFetchOldAsyncMessages=!1,this.bSessionActive?c.sendRequest(e).done((function(e){t.resolve(e)})).fail((function(e){s.onError(e),t.reject(e)})):t.reject("There is no active chat session."),t.promise()}},{key:"updateUserData",value:function(e){var t=r.default.Deferred(),s=this.oSessionData.sessionId,o=this.oConfig;return l.default.request({url:o.sServerURL+"/"+s+"/userdata",type:"PUT",crossDomain:!0,headers:c.getHeaders(),data:{data:e,operationId:l.default.guid()},timeout:o.iAjaxTimeout,success:function(e){return t.resolve(e)},error:function(e){return t.reject(e)}}),t.promise()}},{key:"fetchHistory",value:function(){var e=r.default.Deferred(),t=this,s=this.maxMessagePageSize,o=this.previousStartIndex,n=this.bAllMessagesReceived,i=this.oSessionData,a=this.oConfig;if(!this.bAsyncMode)return e.reject("Fetching messages history applies to only Asynchronous chat."),e.promise();if(this.bFetchOldAsyncMessages=!0,n)t.continuePoll(),e.reject("No more messages to fetch");else{var u=i.sessionId,d=a.sServerURL;u&&o&&(this.pausePoll(),l.default.request({url:d+"/"+u+"/messages?index="+o+"&count="+s+"&operationId="+l.default.guid(),type:"GET",crossDomain:!0,headers:c.getHeaders(),success:function(s){if(s&&s.data){var o=s.data.messages;o&&o.length&&c.parseTranscript(o,{type:"fetchHistory"}),e.resolve(s)}else t.bFetchOldAsyncMessages=!1,t.continuePoll(),e.reject(s)},error:function(s){t.bFetchOldAsyncMessages=!1,t.continuePoll(),t.onError(s),e.reject(s)}}))}return e.promise()}},{key:"asyncRestore",value:function(){var e=r.default.Deferred();if(l.default.getCookie(this.sCookie_Session))this.restore(),e.resolve();else if(this.bAsyncMode&&"function"==typeof this.setSessionData){var t=c.getCustomerToken().token;t?(this.restore(t),e.resolve()):e.reject()}else e.reject();return e.promise()}},{key:"restore",value:function(e){var t=r.default.Deferred(),s=this.oConfig,o=s.sServerURL,n=s.iAjaxTimeout,i=s.oHeaders,u=this;if(this.bRestoring)return t.reject("Already restoring. Ignoring request."),!1;if(this.bSessionActive&&t.reject("Chat session is already active, ignoring restore command."),this.bAsyncMode&&e){this.bRestoring=!0,this.onCapabilitiesChanged(this.capabilities);var d=c.getFormData(),p={"x-nexus-client-key":e};i&&(p=a({},p,i)),l.default.request({url:o,type:"POST",crossDomain:!0,headers:p,data:{data:d,operationId:l.default.guid()},timeout:n,success:function(s){if(s.data&&s.data.clientToken){var n=s.data;u.oSessionData=l.default.decodeJWTToken(n.clientToken),u.oSessionData.token=n.clientToken,c.updateSessionCookies();var i=u.oSessionData.sessionId;i?l.default.request({url:o+"/"+i+"/messages?count="+u.maxMessagePageSize+"&operationId="+l.default.guid(),type:"GET",crossDomain:!0,headers:c.getHeaders(),success:function(s){var o=!!e;1==c.restore(s,o)?t.resolve(s):t.reject(s)},error:function(e){u.onRestoreFailed(e),u.onError(e),t.reject(e)}}):t.reject("Cannot restore async chat")}else t.reject("Cannot start async chat:"),u.onRestoreFailed(s),u.onError(s)},error:function(e){t.reject(e||{}),u.onRestoreFailed(e),c.handleError(e)}})}else{c.getSessionFromCookie();var g=u.oSessionData.sessionId;if(this.bAsyncMode&&!g){g=l.default.getCookie(u.sCookie_Session);var f=c.getCustomerToken().token;u.oSessionData=l.default.decodeJWTToken(f)}u.bRestoring=!0,u.onCapabilitiesChanged(u.capabilities),g&&l.default.request({url:o+"/"+g+"/messages?count="+u.maxMessagePageSize+"&operationId="+l.default.guid(),type:"GET",crossDomain:!0,timeout:n,headers:c.getHeaders(),success:function(e){1==c.restore(e)?t.resolve(e):(t.reject(e),u.onRestoreFailed(e),c.terminateChatSession())},error:function(e){u.onError(e),u.onRestoreFailed(e),c.terminateChatSession(),t.reject(e)}})}return t.promise()}},{key:"endChat",value:function(){var e=r.default.Deferred(),t=this.oSessionData,s=t.sessionId,o=t.participantId,n=this.oConfig,i=this;return this.bFetchOldAsyncMessages=!1,this.bSessionActive||e.reject("There is no active chat session"),this.stopPoll(),l.default.request({url:n.sServerURL+"/"+s+"/participants/"+o,type:"DELETE",crossDomain:!0,headers:c.getHeaders(),data:{operationId:l.default.guid()},success:function(t){i.onChatEnded(t),i.onAgentDisconnected({agents:i.oAgents}),e.resolve(t)},error:function(t){i.onChatEnded(),e.reject()}}).always(c.terminateChatSession),e.promise()}},{key:"fetchSessionData",value:function(){return this.oSessionData}},{key:"getAgents",value:function(){return this.oAgents}},{key:"getFileLimits",value:function(){return r.default.Deferred().reject("This transport doesn't support getFileLimits command.").promise()}},{key:"downloadFile",value:function(){return r.default.Deferred().reject("This transport doesn't support file download.").promise()}},{key:"sendCustomNotice",value:function(){return r.default.Deferred().reject("This transport doesn't support sendCustomNotice command.").promise()}},{key:"resetPollExceptions",value:function(){return r.default.Deferred().reject("This transport doesn't support any poll Exceptions.").promise()}}]),e}();CXBus.registerModule("pure-engage-v3-rest-transport",d)}},["./webapp/plugins/cx-webchat-service/transports/pure-engage-v3-rest-transport.js"]);