/*!
 * widgets
 * @version: 9.0.017.00
 * @license: Genesys Telecom Labs
 */
widgetsJsonpFunction([22],{"./webapp/plugins/cx-webchat-service/controllers/transport-controller.js":function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=o(n("./node_modules/jquery/dist/jquery.js")),i=o(n("./webapp/plugins/cx-common/cx-common.js"));CXBus.registerModule("webchatservicenextgen",(function(){function e(){g=!1,h=[],y=[]}function t(){i.default.deleteCookie(v)}function n(e,t){e().done((function(e){t.deferred.resolve(e)})).fail((function(e){t.deferred.reject(e)}))}function o(){if(i.default.getCookie(v)){var e=JSON.parse(i.default.getCookie(v));return a.default.each(e.custom,(function(){b.custom.push(new RegExp(this.source,this.flags))})),!0}return!1}function s(e){if(e instanceof RegExp){e.length||(e=[e]);for(var t=0;t<e.length;t++)b.custom.filter((function(n){return String(n)===String(e[t])})).length||b.custom.push(e[t]);!function(){for(var e,t={custom:[]},n=0;n<b.custom.length;n++)e=b.custom[n],t.custom.push({source:e.source,flags:e.flags});i.default.setCookie(v,JSON.stringify(t))}()}}function d(){b.custom=[],i.default.deleteCookie(v)}function c(e){return D.push(e),e}function l(i){var l=a.default.Deferred(),v={async:!1,asyncClose:"hideChat",pagination:!1,fileUpload:!0};if(u.registerEvents(["ready","restored","restoreTimeout","restoreFailed","messageReceived","error","started","ended","agentTypingStarted","agentTypingStopped","agentTypingTimeout","pollingStarted","pollingStopped","clientConnected","clientDisconnected","agentConnected","agentDisconnected","supervisorConnected","supervisorDisconnected","clientTypingStarted","clientTypingStopped","ajaxResponse","disconnected","reconnected","chatServerWentOffline","chatServerBackOnline","capabilitiesChanged","sleeping","waking","sessionLost"]),m.sleepEnabled&&u.data("sleeping",!1),m&&f){var S="";"pureengage-v3-rest"==f?S="pure-engage-v3-rest-transport":"purecloud-v2-sockets"==f?S="pure-cloud-v2-sockets-transport":i.deferred.reject("Invalid transport configuration"),S&&CXBus.loadModule(S).done((function(i){(p=new i(m)).onChatStarted=function(e,t){u.publish("started",e),u.command("App.registerAutoLoad")},p.onPollingStarted=function(){u.publish("pollingStarted")},p.onPollingStopped=function(){u.publish("pollingStopped")},p.onTypingStarted=function(){u.publish("clientTypingStarted")},p.onTypingStopped=function(){u.publish("clientTypingStopped")},p.onAgentConnected=function(e){u.publish("agentConnected",e)},p.onAgentDisconnected=function(e){u.publish("agentDisconnected",e)},p.onAgentTypingStarted=function(e){u.publish("agentTypingStarted",e)},p.onAgentTypingTimeout=function(e){u.publish("agentTypingTimeout",e)},p.onAgentTypingStopped=function(e){u.publish("agentTypingStopped",e)},p.onBotConnected=function(e){u.publish("botConnected",e)},p.onBotDisconnected=function(e){u.publish("botDisconnected",e)},p.onSuperVisorConnected=function(e){u.publish("supervisorConnected",e)},p.onSuperVisorDisconnected=function(e){u.publish("supervisorDisconnected",e)},p.onClientConnected=function(e){u.publish("clientConnected",e)},p.onClientDisconnected=function(e){u.publish("clientDisconnected",e)},p.onSleep=function(){m.sleepEnabled&&u.publish("sleeping")},p.onWake=function(){u.publish("waking")},p.onMessageReceived=function(e){if(e.data){var t=e.data;t.messages instanceof Array&&(t.messages=t.messages.map((function(e){var t=null;return function(e){var t=a.default.Deferred(),n=D.length;return n?D.forEach((function(o,r){e=o(e)||e,n===r+1&&t.resolve(e)})):t.resolve(e),t.promise()}(e).done((function(e){t=e})),t})).filter((function(e){return function(e){for(var t=0;t<b.standard.length;t++)if((e+"").match(b.standard[t]))return!1;for(var n=0;n<b.custom.length;n++)if((e+"").match(b.custom[n]))return!1;return!0}(e.text||"")})),h=h.concat(t.messages)),t.originalMessages instanceof Array&&(y=y.concat(t.originalMessages)),u.publish("messageReceived",{originalMessages:t.originalMessages,messages:t.messages,restoring:t.restoring,sessionData:t.sessionData,oldMessages:t.oldMessages})}},p.onCapabilitiesChanged=function(e){e.async&&(v.async=e.async),e.asyncClose&&(v.asyncClose=e.asyncClose),"boolean"==typeof e.pagination&&(v.pagination=e.pagination),"boolean"==typeof e.fileUpload&&(v.fileUpload=e.fileUpload),u.data("capabilities",v),u.publish("capabilitiesChanged",v)},p.onRestore=function(e){u.publish("restored",e),e&&e.async&&u.data("WebChatService.mode",{async:!0})},p.onRestoreFailed=function(n){e(),t(),u.publish("restoreFailed",n)},p.onRestoreTimeout=function(){t(),u.publish("restoreTimeout")},p.onReconnected=function(){u.publish("reconnected")},p.onDisconnected=function(){u.publish("disconnected")},p.onChatServerWentOffline=function(){u.publish("chatServerWentOffline")},p.onChatServerBackOnline=function(){u.publish("chatServerBackOnline")},p.onChatEnded=function(){e(),t(),d(),u.publish("clientDisconnected"),u.publish("ended"),u.command("App.deregisterAutoLoad")},p.onSessionLost=function(n){e(),t(),u.publish("sessionLost",n)},p.onError=function(e){u.publish("error",{errors:[e]})},u.registerCommand("startChat",(function(e){g?e.deferred.reject("There is already an active chat session"):(m.sleepEnabled&&u.command("wake"),e.data&&(e.data.userData&&u.data("userData",a.default.extend(!0,u.data("userData"),e.data.userData||{})),e.data.interactionData&&u.data("interactionData",a.default.extend(!0,u.data("interactionData"),e.data.interactionData||{}))),p.startChat(e.data).done((function(t){u.publishDirect("ajaxResponse",t),g=!0,e.deferred.resolve(t)})).fail((function(t){e.deferred.reject(t)})))})),u.registerCommand("sendMessage",(function(e){T.Interval&&p.onTypingStopped(),clearInterval(T.Interval),T.Interval=!1,T.Timer=0,T.text="",T.IdleCount=0,"string"!=typeof e.data.message||""==(e.data.message+"").trim()?e.deferred.reject("No message text provided"):(m.sleepEnabled&&u.command("wake"),p.sendMessage(e.data).done((function(t){e.deferred.resolve(t)})).fail((function(t){e.deferred.reject(t)})))})),u.registerCommand("endChat",(function(e){p.endChat().done((function(t){e.deferred.resolve(t||{})})).fail((function(t){e.deferred.reject(t)})),g=!1})),u.registerCommand("asyncRestore",(function(e){p.asyncRestore().done((function(){g=!0,e.deferred.resolve()})).fail((function(){e.deferred.reject()}))})),u.registerCommand("fetchHistory",(function(e){p.fetchHistory().done((function(t){e.deferred.resolve(t)})).fail((function(t){e.deferred.reject(t)}))})),u.registerCommand("getSessionData",(function(e){e.deferred.resolve(p.fetchSessionData())})),u.registerCommand("startPoll",(function(e){if(!g)return e.deferred.reject("There is no active chat session"),!1;"function"==typeof p.startPoll?(p.startPoll(),e.deferred.resolve()):e.deferred.reject("This transport doesn't support polling.")})),u.registerCommand("pausePoll",(function(e){if(!g)return e.deferred.reject("There is no active chat session"),!1;"function"==typeof p.pausePoll?(p.pausePoll(),e.deferred.resolve()):e.deferred.reject("This transport doesn't support polling.")})),u.registerCommand("stopPoll",(function(e){"function"==typeof p.stopPoll?p.stopPoll().done((function(){e.deferred.resolve()})).fail((function(t){e.deferred.reject(t)})):e.deferred.reject("This transport doesn't support polling.")})),u.registerCommand("poll",(function(e){e.commander!=u.namespace()&&e.deferred.reject("Access Denied to private command. Only WebChatService is allowed to invoke this command"),"function"==typeof p.poll?p.poll().done((function(){e.deferred.resolve()})).fail((function(t){e.deferred.reject(t)})):e.deferred.reject("This transport doesn't support polling.")})),u.registerCommand("resetPollExceptions",(function(e){"function"==typeof p.resetPollExceptions?n(p.resetPollExceptions,e):e.deferred.reject("This transport doesn't support resetPollExceptions command.")})),u.registerCommand("getAgents",(function(e){e.deferred.resolve({agents:p.getAgents()})})),u.registerCommand("getTranscript",(function(e){e.deferred.resolve({messages:h,originalMessages:y})})),u.registerCommand("getStats",(function(e){var t={agents:p.getAgents()||{},startTime:!1,endTime:!1,duration:!1};h.length>0&&(t.startTime=h[0].timestamp,t.endTime=h[h.length-1].timestamp,t.duration=new Date(t.endTime)-new Date(t.startTime)),e.deferred.resolve(t)})),u.registerCommand("registerPreProcessor",(function(e){"function"==typeof e.data.preprocessor?e.deferred.resolve(c(e.data.preprocessor)):e.deferred.reject("No preprocessor function provided. Type provided was '"+r(e.data.preprocessor)+"'.")})),u.registerCommand("getFileLimits",(function(e){"function"==typeof p.getFileLimits?n(p.getFileLimits,e):e.deferred.reject("This transport doesn't support getFileLimits command.")})),u.registerCommand("sendCustomNotice",(function(e){"function"==typeof p.sendCustomNotice?n(p.sendCustomNotice,e):e.deferred.reject("This transport doesn't support sendCustomNotice command.")})),u.registerCommand("downloadFile",(function(e){"function"==typeof p.downloadFile?n(p.downloadFile,e):e.deferred.reject("This transport doesn't support file download.")})),u.registerCommand("addPrefilter",(function(e){if(e.data.filters&&e.data.filters instanceof RegExp)s(e.data.filters),e.deferred.resolve(a.default.extend({},b.custom));else if(e.data.filters&&e.data.filters.length>0&&e.data.filters[0]instanceof RegExp){for(var t=0;t<e.data.filters.length;t++)s(e.data.filters[t]);e.deferred.resolve(a.default.extend({},b.custom))}else e.deferred.reject("Missing or invalid filters provided. Please provide a regular expression or an array of regular expressions")})),u.registerCommand("sendFilteredMessage",(function(e){g?(function(e,t){"string"==typeof e&&t instanceof RegExp&&(s(t),u.command("sendMessage",{message:e}))}(e.data.message,e.data.regex),e.deferred.resolve()):e.deferred.reject("No active chat session.")})),u.registerCommand("restore",(function(e){var t=e.data&&e.data.sessionData||{};p.restore(t).done((function(t){g=!0,e.deferred.resolve(t)})).fail((function(t){e.deferred.reject(t)}))})),u.registerCommand("sendFile",(function(e){p.sendFile(e).done((function(t){e.deferred.resolve(t)})).fail((function(t){e.deferred.reject(t)}))})),u.registerCommand("registerTypingPreviewInput",(function(e){var t=(0,a.default)(e.data.input);!t||"text"!=t[0].type&&"textarea"!=t[0].type?e.deferred.reject("Invalid value provided for the 'input' property. An HTML element reference to a textarea or text input is required."):(C=(0,a.default)(t),e.deferred.resolve())})),u.registerCommand("updateUserData",(function(e){var t=m,n=u.data("userData")||{};u.data("userData",a.default.extend(!0,n,e.data||{})),a.default.extend(!0,t.oUserData,u.data("userData")),g?p.updateUserData(e.data).done((function(t){e.deferred.resolve(t)})).fail((function(t){e.deferred.reject(t)})):e.deferred.resolve(t.oUserData)})),u.registerCommand("updateInteractionData",(function(e){var t=m,n=u.data("interactionData")||{};u.data("interactionData",a.default.extend(!0,n,e.data||{})),a.default.extend(!0,t.oInteractionData,u.data("interactionData")),g?p.updateInteractionData(e.data).done((function(t){e.deferred.resolve(t)})).fail((function(t){e.deferred.reject(t)})):e.deferred.resolve(t.oInteractionData)})),u.registerCommand("sendTyping",(function(e){var t=T;if(t.Interval)t.Timer=0,e.deferred.resolve();else{var n=e.data,o=!1;n.type="TypingStarted",n.message=n.message||C&&C.val()||"",o=p.sendTyping(n),p.onTypingStarted(),t.Interval=setInterval((function(){t.Timer+=t.TimeInterval,t.Timer>=t.Timeout&&(n.type="TypingStopped",n.message=n.message||C&&C.val()||"",clearInterval(t.Interval),t.Interval=!1,t.Timer=0,o=p.sendTyping(n),p.onTypingStopped())}),t.TimeInterval),o.done((function(t){e.deferred.resolve(t)})).fail((function(t){e.deferred.reject(t)}))}})),u.registerCommand("sleep",(function(e){m.sleepEnabled&&!u.data("sleeping")&&g&&(u.publish("sleeping"),u.data("sleeping",!0),"function"==typeof p.pausePoll&&p.pausePoll()),e.deferred.resolve()})),u.registerCommand("wake",(function(e){m.sleepEnabled&&u.data("sleeping")&&g&&(u.publish("waking"),u.data("sleeping",!1),"function"==typeof p.continuePoll&&p.continuePoll()),e.deferred.resolve()})),u.subscribe("App.data.pageFocus",(function(e){m.sleepEnabled&&g&&(!1===e.data.value?u.command("sleep"):!0===e.data.value&&u.command("wake"))})),u.subscribe("App.data.pageHidden",(function(e){m.sleepEnabled&&g&&(!1===e.data.value?u.command("wake"):!0===e.data.value&&u.command("sleep"))})),o(),u.ready(),u.republish("ready"),l.resolve()}))}return l.promise()}var u="",f="",p={},g=!1,m={sCookie_Prefix:"_genesys.widgets.webchat.state",oUserData:{},oInteractionData:{},sleepEnabled:!1},v=m.sCookie_Prefix+".filters",h=[],y=[],b={standard:[/\{start\:[0-9]{9}\}/],custom:[]},C=!1,T={Timer:0,Timeout:2e3,TimeInterval:100,Interval:!1,IdleCount:0,IdleLimit:2,Text:""},D=[];return{init:function(e){(u=e)&&(u.registerCommand("configure",(function(e){if(e.data&&Object.keys(e.data).length){var t=e.data,n="object",o=m;if(r(t.userData)==n&&a.default.extend(o.oUserData,t.userData),"number"==r(t.ajaxTimeout)&&(o.iAjaxTimeout=parseInt(t.ajaxTimeout)),r(t.transport)==n){var i=t.transport;"string"==r(i.type)&&(f=i.type),r(i.interactionData)==n&&(o.oInteractionData=i.interactionData),"boolean"==r(i.sleepEnabled)&&(o.sleepEnabled=i.sleepEnabled),o.transport=i}u.data("userData",o.oUserData),u.data("interactionData",o.oInteractionData),"boolean"==typeof t.enableCustomHeader&&(o.bEnableCustomHeader=t.enableCustomHeader),l(e).done((function(){u.command("asyncRestore")})).fail((function(t){e.deferred.reject(t)})),e.deferred.resolve()}else e.deferred.reject("Invalid configuration")})),u.command("configure",_genesys.widgets.webchat))}}}))}},["./webapp/plugins/cx-webchat-service/controllers/transport-controller.js"]);