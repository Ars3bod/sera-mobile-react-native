/*!
 * widgets
 * @version: 9.0.017.00
 * @license: Genesys Telecom Labs
 */
widgetsJsonpFunction([20],{"./webapp/plugins/cx-webchat-service/transports/pure-cloud-v2-sockets-transport.js":function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},i=o(n("./node_modules/jquery/dist/jquery.js")),c=o(n("./webapp/plugins/cx-common/cx-common.js")),d={init:function(e){d.transport=e},updateSessionCookies:function(){var e=d.transport,t=e.oSessionData;c.default.setCookie(e.sCookie_Keys,t.jwt),c.default.setCookie(e.sCookie_ConversationID,t.conversationId),c.default.setCookie(e.sCookie_MemberID,t.memberId),c.default.setCookie(e.sCookie_WS_URL,t.WebSocketUrl),c.default.setCookie(e.sLastMessageId,t.lastMessageId)},removeCookies:function(){var e=d.transport;c.default.deleteCookie(e.sCookie_Keys),c.default.deleteCookie(e.sCookie_ConversationID),c.default.deleteCookie(e.sCookie_MemberID),c.default.deleteCookie(e.sCookie_WS_URL),c.default.deleteCookie(e.sLastMessageId)},getSessionFromCookie:function(){var e=d.transport,t=d.transport.oSessionData;t.jwt=c.default.getCookie(e.sCookie_Keys),t.conversationId=c.default.getCookie(e.sCookie_ConversationID),t.memberId=c.default.getCookie(e.sCookie_MemberID),t.WebSocketUrl=c.default.getCookie(e.sCookie_WS_URL),t.lastMessageId=c.default.getCookie(e.sLastMessageId),e.customerId=t.memberId},terminateChatSession:function(){var e=d.transport;d.removeCookies(),e.bSessionActive=!1,e.mySocket&&(clearTimeout(e.WebSocketTimeout),e.mySocket.readyState===WebSocket.OPEN&&setTimeout((function(){e.mySocket&&e.mySocket.close()}),e.socketConnectionCloseTime),e.mySocket=null),e.oAgents={},e.oClients={},e.oWorkFlows={},e.oSessionData={},e.bAllMessagesReceived=!1,e.bOpeningSocket=!1,e.bFetchingMembers=!1},getFormData:function(e){if(e){var t=c.default.getBrowserandOS(),n=e.firstname,o=e.lastname,s=e.nickname,i=function(e,t){var n={};for(var o in e)t.indexOf(o)>=0||Object.prototype.hasOwnProperty.call(e,o)&&(n[o]=e[o]);return n}(e,["firstname","lastname","nickname"]),m={_genesys_source:c.default.isMobileDevice()?"mobile":"web",_genesys_referrer:document.referrer,_genesys_url:document.location.href,_genesys_pageTitle:document.title,_genesys_browser:t.browser,_genesys_OS:t.os},g=r({},d.transport.oUserData,m);return"object"==a(e.userData)&&(g=r({},g,e.userData)),r({firstName:n,lastName:o,nickname:s||n||e.firstName},g,i)}return{}},parseTranscript:function(e,t){var n=d.transport,o=[];clearInterval(n.fWatchMembers),n.fWatchMembers=!1,i.default.each(e||[],(function(){d.checkChatIndexHash(this.id)&&o.push(d.parseFormatmessage(this,t))})),o.sort((function(e,t){return e.timestamp-t.timestamp})),t&&"fetchHistory"==t.type&&o.sort((function(e,t){return t.index-e.index})),o.length>0&&n.onMessageReceived({data:{originalMessages:e,messages:o,restoring:n.bRestoring,oldMessages:t&&"fetchHistory"==t.type}})},checkChatIndexHash:function(e){var t=d.transport;return!t.oChatIndexHash[e]&&(t.oChatIndexHash[e]=!0,!0)},sendBotConnected:function(e,t){var n=d.transport;d.postMessageWithTimestamp({type:"ParticipantJoined",index:t?t.index:0,timestamp:t?t.timestamp:Date.now(),from:{type:"Bot"}}),n.onBotConnected({message:e,agents:n.oAgents})},sendBotDisconnected:function(e,t){var n=d.transport;d.postMessageWithTimestamp({type:"ParticipantLeft",index:t?t.index:"",timestamp:t?t.timestamp:Date.now(),from:{type:"Bot"}}),n.onBotDisconnected({message:e,agents:n.oAgents})},parseMessageForEvents:function(e,t){var n=d.transport,o=(t||{}).type,s=!(!o||"restore"!==o&&"fetchHistory"!==o),a={};if(e&&e.state){var r=e.state,i=e.role,c=e.sender.id;if("CONNECTED"==r)switch("AGENT"==i&&n.oAgents[c]&&(n.oAgents[c].connected=!0,n.oAgents[c].supervisor=!1,n.oAgents[c].connectedTime=e.joinDate,n.oCacheAgents[c]=JSON.parse(JSON.stringify(n.oAgents[c]))),a={message:e,agents:n.oAgents},i){case"AGENT":d.checkEventChanged(c,r)&&n.onAgentConnected(a);break;case"CUSTOMER":d.checkEventChanged(c,r)&&n.onClientConnected(a);break;case"WORKFLOW":n.botEventsEnabled&&d.checkEventChanged(c,r)&&n.onBotConnected(a)}else if("DISCONNECTED"==r)switch("AGENT"==i&&n.oAgents[c]&&(n.oAgents[c].connected=!1,n.oAgents[c].disconnectedTime=e.leaveDate),a={message:e,agents:n.oAgents},i){case"AGENT":n.onAgentDisconnected(a),n.onAgentTypingStopped(a);break;case"CUSTOMER":n.onClientDisconnected(a);break;case"WORKFLOW":n.botEventsEnabled&&n.onBotDisconnected(a)}s&&(n.oMembers[c]=e,n.oMembers[c].lastEvent=r)}},parseFormatmessage:function(e,t){var n=d.transport,o=new Date(e.timestamp||e.joinDate||e.leaveDate).getTime(),s=(t||{}).type,a=!(!s||"restore"!==s&&"fetchHistory"!==s),r={},i={};if(r.type=n.webSocketStateMapping[e.bodyType]||"Message","Message"===r.type&&(r.text=e.body),r.restoring=n.bRestoring,r.index=o,r.timestamp=o,n.oPresences&&Object.keys(n.oPresences).length){i=n.oPresences.filter((function(t){return t.id==e.sender.id}));for(var c=0;c<i.length;c++)i=i[c],e.role=i&&i.role?i.role:n.oMembers[e.sender.id].role,e.state=n.stateMapping[r.type],"AGENT"==e.role&&(n.agentMsgFormat.avatar=i&&i.avatarImageUrl?i.avatarImageUrl:"",i&&"CONNECTED"==i.state&&(n.agentMsgFormat.from.name=i&&i.displayName?i.displayName:""))}if(e.role&&"AGENT"===e.role&&n.agentMsgFormat.avatar&&(r.avatar=n.agentMsgFormat.avatar),a&&i.state&&e.role){var m=i.role;d.checkEventChanged(i.id,e.state)&&("AGENT"==m&&(r.from={type:"Agent",name:i.displayName},n.oAgents[i.id]={name:i.displayName}),"CUSTOMER"==m&&(r.from={type:"Client",name:i.displayName},n.oClients[i.id]={name:i.displayName}),"WORKFLOW"===m&&(n.botEventsEnabled&&"DISCONNECTED"===e.state&&(r.from={type:"Bot"}),"standard"===e.bodyType||n.botEventsEnabled&&"member-join"===e.bodyType?(r.from={type:"Bot"},n.oWorkFlows[i.id]={type:"Bot"}):"notice"===e.bodyType&&(n.oWorkFlows[i.id]={type:"External"})))}if("Message"===r.type){var g=d.getSenderById(e);g&&(a||(r.from=g.from||{}),g.avatar&&(r.avatar=g.avatar))}return d.parseMessageForEvents(e,t),r},getSenderById:function(e){var t=d.transport,n=e.sender.id,o=t.oMembers[n]||t.oWorkFlows[n],s="",a={id:n};return o&&("WORKFLOW"===o.role?"standard"===e.bodyType?a.type="Bot":"notice"===e.bodyType&&(a.type="External"):"AGENT"===o.role?(a.name=t.oAgents[n]&&t.oAgents[n].name||t.oMembers[n]&&t.oMembers[n].displayName||"Agent",a.type="Agent",s=t.oMembers[n]&&t.oMembers[n].avatarImageUrl):"CUSTOMER"===o.role&&(a.name=t.oClients[n]&&t.oClients[n].name||t.oMembers[n]&&t.oMembers[n].displayName||"Client",a.type="Client")),{from:a,avatar:s}},checkEventChanged:function(e,t){var n=d.transport.oMembers;if(Object.keys(n).length&&n[e]){var o=n[e];return!o.lastEvent||o.lastEvent!==t}return!0},processSocketFrame:function(e){var t=d.transport,n=t.oSessionData,o=e&&e.eventBody,s=e&&e.metadata;if(o&&("WebSocket Heartbeat"==o.message||s)&&(clearTimeout(t.WebSocketTimeout),t.WebSocketTimeout=setTimeout((function(){t.mySocket&&WebSocket.OPEN&&(t.bSocketConnectionLost=!0,t.onDisconnected(),t.mySocket.close())}),t.socketHeartbeatTrackerInterval)),s&&o){var a=s.type,r="";switch(a){case"typing-indicator":var i,c=o.sender.id,m=t.oAgents,g={},u=[];if(t.oPresences&&Object.keys(t.oPresences).length){u=t.oPresences.filter((function(e){return e.id==c}));for(var p=0;p<u.length;p++)u=u[p],"AGENT"==t.oMembers[c].role&&(t.agentMsgFormat.avatar=u&&u.avatarImageUrl?u.avatarImageUrl:"")}i=t.agentMsgFormat.avatar,m[c]&&(g.from={name:m[c].name,id:c,avatar:i},t.onAgentTypingStarted(g),t.bAgentTypingTimerActive||(t.bAgentTypingTimerActive=!0,setTimeout((function(){t.bAgentTypingTimerActive=!1,t.onAgentTypingTimeout()}),t.iAgentTypingTimer)));break;case"member-change":var l,f=o.member;r=f.id,l=t.oMembers[r]&&t.oMembers[r].lastEvent?t.oMembers[r].lastEvent:"",n.memberId&&t.bSessionActive?r!=n.memberId?d.getMemberById(r).done((function(e){t.oMembers[r]=e,l&&(t.oMembers[r].lastEvent=l),e&&d.checkEventChanged(r,f.state)&&("AGENT"==e.role?(t.agentMsgFormat.avatar=e.avatarImageUrl,"DISCONNECTED"==e.state&&(t.agentMsgFormat.type="ParticipantLeft",t.agentMsgFormat.from.name=e.displayName||"",void 0!==t.oAgents[r]&&(t.oAgents[r].name=e.displayName,t.oAgents[r].connected=!1,t.oAgents[r].disconnectedTime=Date.now()),t.oCacheAgents[r]&&t.oCacheAgents[r].connected&&(t.oCacheAgents[r].connected=!1,t.oCacheAgents[r].disconnectedTime=Date.now(),t.oCacheAgents[r].name=e.displayName,d.postMessageWithTimestamp(t.agentMsgFormat),t.onAgentDisconnected({message:e,agents:t.oCacheAgents}))),"CONNECTED"==e.state&&(t.agentMsgFormat.type="ParticipantJoined",t.agentMsgFormat.from.name=e.displayName||"",null==t.oAgents[r]&&(t.oAgents[r]={name:e.displayName||"",connected:!0,supervisor:!1,connectedTime:Date.now(),disconnectedTime:!1}),t.oCacheAgents[r]=JSON.parse(JSON.stringify(t.oAgents[r])),t.oCacheAgents[r].connected=!0,d.postMessageWithTimestamp(t.agentMsgFormat),t.onAgentConnected({message:e,agents:t.oAgents}))):"WORKFLOW"===e.role&&("CONNECTED"==e.state&&(null==t.oWorkFlows[r]&&(t.oWorkFlows[r]={name:e.displayName||"",role:"WORKFLOW",connected:!0,connectedTime:Date.now(),disconnectedTime:!1}),t.botEventsEnabled&&d.sendBotConnected(e)),"DISCONNECTED"==e.state&&(void 0!==t.oWorkFlows[r]&&(t.oWorkFlows[r].name=e.displayName||"",t.oWorkFlows[r].connected=!1,t.oWorkFlows[r].disconnectedTime=Date.now()),t.botEventsEnabled&&d.sendBotDisconnected(e))),t.oMembers[r]=e,t.oMembers[r].lastEvent=e.state),t.bFetchingMembers=!1})).fail((function(e){d.handleError(e)})):r==n.memberId&&("DISCONNECTED"===f.state&&t.bSessionActive&&(t.onChatEnded(),d.terminateChatSession()),t.oMembers[r]=f,t.oMembers[r].role="CUSTOMER",t.oMembers[r].lastEvent=f.state):!t.bSessionActive&&f&&"DISCONNECTED"==f.state&&t.customerId&&r!==t.customerId&&t.oCacheAgents[r]&&t.oCacheAgents[r].connected&&(t.agentMsgFormat.type="ParticipantLeft",d.postMessageWithTimestamp(t.agentMsgFormat),t.oCacheAgents[r].connected=!1,t.oCacheAgents[r].disconnectedTime=Date.now(),t.onAgentDisconnected({message:o,agents:t.oCacheAgents}));break;case"message":n.lastMessageId=o.id,d.updateSessionCookies(),t.aMsgsBuffer.push(o),t.fWatchMembers||(t.fWatchMembers=setInterval((function(){var e=t.aMsgsBuffer.filter((function(e){return e.sender.id?t.oMembers[e.sender.id]?e:void 0:e}));t.bFetchingMembers||e.length!=t.aMsgsBuffer.length||(clearInterval(t.fWatchMembers),t.fWatchMembers=!1,d.parseTranscript(t.aMsgsBuffer),t.aMsgsBuffer=[])}),t.iWatchMembers))}}},postMessageWithTimestamp:function(e){var t=d.transport;e.timestamp=Date.now(),e.index=e.timestamp,t.onMessageReceived({data:{originalMessages:[e],messages:[e],restoring:t.bRestoring}})},getNickname:function(e){return e.nickname?e.nickname:e.firstName&&e.lastName&&"string"==typeof e.firstName&&"string"==typeof e.lastName?e.firstName+" "+e.lastName:e.firstName&&"string"==typeof e.firstName?e.firstName:"Customer"},getPresences:function(){var e=i.default.Deferred(),t=d.transport,n=t.oSessionData,o=d.CreateUrl("/api/v2/webchat/guest/conversations/"+n.conversationId+"/members");return c.default.request(r({},t.oCommonRequestOption,{headers:{Authorization:"Bearer "+t.oSessionData.jwt},type:"GET",url:o,success:function(t){t&&e.resolve(t)},error:function(t){return e.reject(t)}})),e.promise()},requestMessages:function(e,t,n){var o=d.transport;c.default.request(r({},o.oCommonRequestOption,{headers:{Authorization:"Bearer "+o.oSessionData.jwt},type:"GET",url:e,success:function(s){s?(s.entities&&(t=t.concat(s.entities)),s.next?(e=o.dataURL+s.next,d.requestMessages(e,t,n)):n.resolve(t)):n.reject(s)},error:function(e){return n.reject(e)}}))},getAllMessages:function(){var e=i.default.Deferred(),t=d.transport.oSessionData,n=d.CreateUrl("/api/v2/webchat/guest/conversations/"+t.conversationId+"/messages");return d.requestMessages(n,[],e),e.promise()},getOfflineMessages:function(){var e=i.default.Deferred(),t=i.default.Deferred(),n=d.transport,o=n.oSessionData,s="";if(o.conversationId&&o.lastMessageId)return s=d.CreateUrl("/api/v2/webchat/guest/conversations/"+o.conversationId+"/messages",{after:o.lastMessageId}),d.requestMessages(s,[],e),e.promise().done((function(e){d.getPresences().done((function(o){n.bFetchingMembers=!1,n.oPresences=o.entities,d.parseTranscript(e),t.resolve()})).fail((function(){t.resolve()}))})),t.promise()},getNextHundredMessages:function(e){var t=i.default.Deferred(),n=d.transport,o=n.oSessionData,s=[],a="",m={sortOrder:"descending",maxResults:n.maxMessagePageSize};return""!==o.nextMsgURL&&o.previousLastMsgId&&(m.before=o.previousLastMsgId),!n.bAllMessagesReceived&&o.conversationId?(a=d.CreateUrl("/api/v2/webchat/guest/conversations/"+o.conversationId+"/messages",m),c.default.request(r({},n.oCommonRequestOption,{headers:{Authorization:"Bearer "+n.oSessionData.jwt},type:"GET",url:a,success:function(a){a?(a.entities&&(s=a.entities),a.next?(o.previousLastMsgId=s[s.length-1].id,o.nextMsgURL=a.next,n.bAllMessagesReceived=!1):(n.bAllMessagesReceived=!0,o.nextMsgURL=""),d.getPresences().done((function(o){n.oPresences=o.entities,s.length&&s.length<a.pageSize&&!a.next&&(n.bAllMessagesReceived=!0),d.parseTranscript(s,e),t.resolve()})).fail((function(e){t.reject(e)}))):(d.handleError(a),t.reject("200 but no response from server"))},error:function(e){n.onError(e),t.reject()}}))):t.reject("No more messages to fetch"),t.promise()},sendRequest:function(e,t){var n=i.default.Deferred(),o=d.transport,s=e?{data:JSON.stringify(e)}:{};return c.default.request(r({},o.oCommonRequestOption,{headers:{Authorization:"Bearer "+o.oSessionData.jwt},type:"POST",url:t},s,{success:function(e){return n.resolve(e)},error:function(e){return n.reject(e)}})),n.promise()},getMemberById:function(e){var t=i.default.Deferred(),n=d.transport,o=n.oSessionData;return o.conversationId&&e?(n.bFetchingMembers=!0,c.default.request(r({},n.oCommonRequestOption,{headers:{Authorization:"Bearer "+n.oSessionData.jwt},type:"GET",url:d.CreateUrl("/api/v2/webchat/guest/conversations/"+o.conversationId+"/members/"+e),success:function(e){e?t.resolve({id:e.id,displayName:e.displayName,role:e.role,customFields:e.customFields,state:e.state,avatarImageUrl:e.avatarImageUrl||""}):(t.reject(e),n.onError(e))},error:function(e){n.bFetchingMembers=!1,d.handleError(e),t.reject(e||{})}}))):t.reject("No session data available"),t.promise()},getMe:function(){var e=i.default.Deferred(),t=d.transport,n=t.oSessionData;return d.getMemberById(n.memberId).done((function(o){t.bFetchingMembers=!1,t.oClients[n.memberId]={name:o.displayName},t.oMembers[n.memberId]=o,e.resolve(o)})).fail((function(t){e.reject(t)})),e.promise()},getConversationState:function(){var e=i.default.Deferred();return d.getMe().done((function(t){e.resolve(t)})).fail((function(t){e.reject("failed to get the conversation state")})),e.promise()},handleError:function(e){var t=d.transport,n=e&&(e.responseJSON||e.responseText&&JSON.parse(e.responseText)||{});if(n)var o=n.status;t.onError({code:e.errorReason||o&&t.errorPrefix+o||"",response:e})},CreateUrl:function(e,t){var n="",o=d.transport;if(t){n="?";var s=[];for(var a in t){var r=t[a];"string"!=typeof r&&"number"!=typeof r||s.push(a+"="+t[a])}n+=s.join("&")}return""+o.dataURL+e+n},afterConnectionRestore:function(){var e=d.transport;e.bOpeningSocket=!1,d.getOfflineMessages().done((function(){d.getConversationState().done((function(t){e.bSessionActive&&t&&"DISCONNECTED"===t.state&&(e.onChatEnded(),d.terminateChatSession())}))}))},subscribeSocketEvents:function(e){var t=d.transport;t.mySocket.onmessage=function(e){var t=JSON.parse(e.data);d.processSocketFrame(t)},t.mySocket.addEventListener("close",(function(e){clearTimeout(t.WebSocketTimeout),t.bSocketConnectionLost=!0,t.mySocket=null,t.bSessionActive&&(t.bOpeningSocket=!0,d.startWebSocketConnection(),d.afterConnectionRestore())})),t.mySocket.addEventListener("error",(function(n){t.bSocketConnectionLost||d.handleError(n),t.bSessionActive||(e.reject("websocket failed to open"),t.bRestoring&&t.onRestoreFailed()),t.bOpeningSocket=!1}))},startWebSocketConnection:function(e){var t=d.transport,n=i.default.Deferred();return e&&(t.oSessionData={jwt:e.jwt,conversationId:e.id,memberId:e.member.id,WebSocketUrl:e.eventStreamUri},t.customerId=e.member.id),t.mySocket=new WebSocket(t.oSessionData.WebSocketUrl),t.mySocket.addEventListener("open",(function(e){t.bSessionActive=!0,t.bSocketConnectionLost&&(t.bSocketConnectionLost=!1,t.onReconnected()),n.resolve()})),d.subscribeSocketEvents(n),n.promise()}},m=function(){function e(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.transportType="",this.dataURL="",this.mySocket={},this.oUserData=t.oUserData,this.errorPrefix=t.transport.type+"-",this.oChatIndexHash={},this.oPresences={},this.oMembers={},this.oAgents={},this.oClients={},this.oCacheAgents={},this.oWorkFlows={},this.aMsgsBuffer=[],this.maxMessagePageSize=100,this.botEventsEnabled=!1,this.oInteractionData=t.oInteractionData,this.bOpeningSocket=!1,this.bSessionActive=!1,this.bRestoring=!1,this.bAllMessagesReceived=!1,this.bFetchingMembers=!1,this.ajaxTimeout=t.iAjaxTimeout&&t.iAjaxTimeout>=12e3?t.iAjaxTimeout:12e3,this.oCommonRequestOption={timeout:this.ajaxTimeout,crossDomain:!0,dataType:"json",contentType:"application/json"},this.conversationOptions={deploymentId:"",organizationId:"",routingTarget:{targetAddress:""},memberInfo:{displayName:"Customer",role:"CUSTOMER",customFields:{}}},this.oMapping={"form.firstname":{target:"memberInfo.customFields.firstName",type:"string"},"form.lastname":{target:"memberInfo.customFields.lastName",type:"string"},"form.email":{target:"memberInfo.customFields.email",type:"string"},"form.subject":{target:"memberInfo.customFields.subject",type:"string"},"userData.phone":{target:"memberInfo.customFields.phoneNumber",type:"string"},"interactionData.userData.phone":{target:"memberInfo.customFields.phoneNumber",type:"string"},"interactionData.routing.targetType":{target:"routingTarget.targetType",type:"string",default:"QUEUE"},"interactionData.routing.targetAddress":{target:"routingTarget.targetAddress",type:"string"},"interactionData.routing.skills":{target:"routingTarget.skills"},"interactionData.routing.priority":{target:"routingTarget.priority",type:"number"},"interactionData.routing.language":{target:"routingTarget.language",type:"string"},"interactionData.journey.customerId":{target:"journeyContext.customer.id",type:"string"},"interactionData.journey.customerIdType":{target:"journeyContext.customer.idType",type:"string"},"interactionData.journey.sessionId":{target:"journeyContext.customerSession.id",type:"string"},"interactionData.journey.sessionType":{target:"journeyContext.customerSession.type",type:"string"},"interactionData.journey.actionId":{target:"journeyContext.triggeringAction.id",type:"string"},"interactionData.journey.actionMapId":{target:"journeyContext.triggeringAction.actionMap.id",type:"string"},"interactionData.journey.actionMapVersion":{target:"journeyContext.triggeringAction.actionMap.version",type:"number"}},this.webSocketStateMapping={"member-join":"ParticipantJoined","member-leave":"ParticipantLeft",standard:"Message",notice:"Message"},this.stateMapping={ParticipantJoined:"CONNECTED",ParticipantLeft:"DISCONNECTED"},this.oSessionData={jwt:"",conversationId:"",memberId:"",displayName:"",WebSocketUrl:"",nextMsgURL:"",lastMessageId:""},this.customerId="",this.bSocketConnectionLost=!1,this.socketReconnectInterval=2e3,this.socketHeartbeatTrackerInterval=14e3,this.socketConnectionCloseTime=2,this.capabilities={pagination:!0,fileUpload:!1},"object"==a(t.transport)){var n=t.transport;"string"==typeof n.type&&(this.transportType=n.type),"string"==typeof n.dataURL&&(this.dataURL=n.dataURL),"string"==typeof n.deploymentKey&&(this.conversationOptions.deploymentId=n.deploymentKey),"string"!=typeof n.organizationId&&"string"!=typeof n.orgGuid||(this.conversationOptions.organizationId=n.organizationId||n.orgGuid),"number"==typeof n.socketReconnectInterval&&(this.socketReconnectInterval=n.socketReconnectInterval),"number"==typeof n.socketHeartbeatTrackerInterval&&(this.socketHeartbeatTrackerInterval=n.socketHeartbeatTrackerInterval),"boolean"==typeof n.pagination&&(this.capabilities.pagination=n.pagination),"number"==typeof n.maxMessagePageSize&&(this.maxMessagePageSize=n.maxMessagePageSize),"boolean"==typeof n.botEventsEnabled&&(this.botEventsEnabled=n.botEventsEnabled),"number"==typeof n.socketConnectionCloseTime&&(this.socketConnectionCloseTime=n.socketConnectionCloseTime),this.conversationOptions=c.default.mapProperties(this.oMapping,n,this.conversationOptions)}this.sCookie_Keys=t.sCookie_Prefix+"."+this.transportType+".JWtoken",this.sCookie_ConversationID=t.sCookie_Prefix+"."+this.transportType+".ConversationID",this.sCookie_MemberID=t.sCookie_Prefix+"."+this.transportType+".MemberID",this.sCookie_WS_URL=t.sCookie_Prefix+"."+this.transportType+".WS_URL",this.sLastMessageId=t.sCookie_Prefix+"."+this.transportType+".LastMsgId",this.onChatStarted=this.onChatStarted.bind(this),this.onMessageReceived=this.onMessageReceived.bind(this),this.onRestore=this.onRestore.bind(this),this.onError=this.onError.bind(this),this.agentMsgFormat={type:"",text:"",restoring:!1,index:0,timestamp:0,from:{type:"Agent"}},this.conversationStarted={type:"ParticipantJoined",text:"",restoring:!1,index:0,timestamp:0,from:{type:"Client"}},this.iAgentTypingTimer=3e3,this.bAgentTypingTimerActive=!1,this.fWatchMembers=!1,this.iWatchMembers=700,d.init(this)}return s(e,[{key:"onChatStarted",value:function(e,t){}},{key:"onTypingStarted",value:function(e){}},{key:"onCapabilitiesChanged",value:function(e){}},{key:"onAgentTypingStarted",value:function(e){}},{key:"onAgentTypingTimeout",value:function(e){}},{key:"onMessageReceived",value:function(e){}},{key:"onChatEnded",value:function(e){}},{key:"onError",value:function(e){}},{key:"onRestore",value:function(e){}},{key:"onRestoreFailed",value:function(e){}},{key:"startChat",value:function(e){var t=i.default.Deferred(),n=this,o="",s=JSON.parse(JSON.stringify(n.conversationOptions)),a=d.getFormData(e.form);return s.memberInfo.customFields=i.default.extend(s.memberInfo.customFields,a,e.userData||{},!0),s.memberInfo.displayName=d.getNickname(a),"string"==typeof e.deploymentKey&&(s.deploymentId=e.deploymentKey),"string"!=typeof e.organizationId&&"string"!=typeof e.orgGuid||(s.organizationId=e.organizationId||e.orgGuid),n.oInteractionData&&Object.keys(n.oInteractionData).length>0&&(o=n.oInteractionData),e&&e.interactionData&&Object.keys(e.interactionData).length>0&&(o=e.interactionData),o&&(s.memberInfo.customFields=i.default.extend(s.memberInfo.customFields,o.userData||{},!0),s=c.default.mapProperties(n.oMapping,{interactionData:o,userData:s.memberInfo.customFields},s)),n.bSessionActive||n.bOpeningSocket||(n.bOpeningSocket=!0,c.default.request(r({},n.oCommonRequestOption,{type:"POST",url:d.CreateUrl("/api/v2/webchat/guest/conversations"),data:JSON.stringify(s),success:function(e){e?d.startWebSocketConnection(e).done((function(){d.updateSessionCookies(),n.onChatStarted({data:n.oSessionData},e),d.getMe(),t.resolve(),d.postMessageWithTimestamp(n.conversationStarted),n.bOpeningSocket=!1})):(t.reject("no response data in the api post request"),n.onError(e))},error:function(e){e.errorReason="StartFailed",n.bOpeningSocket=!1,t.reject(e||{}),d.handleError(e)}}))),t.promise()}},{key:"sendMessage",value:function(e){var t=i.default.Deferred(),n=this.oSessionData;if(this.bSessionActive){"text"==e.type&&(e.type="Text");var o=d.CreateUrl("/api/v2/webchat/guest/conversations/"+n.conversationId+"/members/"+n.memberId+"/messages");d.sendRequest({body:e.message},o).done((function(e){n.lastMessageId=e.id,d.updateSessionCookies(),t.resolve()})).fail((function(e){e.errorReason="MessageFailed",d.handleError(e),t.reject()}))}else t.reject("There is no active chat session.");return t.promise()}},{key:"sendFile",value:function(){return i.default.Deferred().reject("This transport doesn't support file uploads.").promise()}},{key:"sendTyping",value:function(e){var t=i.default.Deferred(),n=this.oSessionData;if(this.bSessionActive)if(e&&"TypingStopped"!==e.type){var o=d.CreateUrl("/api/v2/webchat/guest/conversations/"+n.conversationId+"/members/"+n.memberId+"/typing");d.sendRequest("",o).done((function(e){e?t.resolve():t.reject("send typing indicator request returned no data")})).fail((function(e){t.reject(e||{})}))}else t.resolve();else t.reject("trying to send typing indicator when session is not active");return t.promise()}},{key:"fetchHistory",value:function(){var e=i.default.Deferred();return this.capabilities.pagination?d.getNextHundredMessages({type:"fetchHistory"}).done((function(){e.resolve()})).fail((function(t){e.reject(t)})):e.reject("Fetching chat history on scroll is not enabled."),e.promise()}},{key:"fetchSessionData",value:function(){return this.oSessionData}},{key:"getAgents",value:function(){return this.oAgents}},{key:"asyncRestore",value:function(){var e=this,t=e.oSessionData,n=i.default.Deferred();return e.onCapabilitiesChanged(this.capabilities),e.bRestoring?(n.reject("Already restoring. Ignoring request."),!1):e.bSessionActive?void n.reject("Chat session is already active, ignoring restore command."):(d.getSessionFromCookie(),t.conversationId&&(e.bRestoring=!0,d.getConversationState().done((function(o){e.bFetchingMembers=!1,"CONNECTED"==o.state?(e.mySocket=new WebSocket(t.WebSocketUrl),d.subscribeSocketEvents(n),e.mySocket.addEventListener("open",(function(t){e.bSessionActive=!0,e.bSocketConnectionLost=!1,e.mySocket.onmessage=function(e){var t=JSON.parse(e.data);d.processSocketFrame(t)},e.onRestore(),e.capabilities.pagination?d.getNextHundredMessages({type:"restore"}).done((function(){e.bRestoring=!1,n.resolve()})):d.getAllMessages().done((function(t){d.getPresences().done((function(n){e.oPresences=n.entities,d.parseTranscript(t,{type:"restore"})})),e.bRestoring=!1,n.resolve()})).fail((function(t){e.onRestoreFailed(t)}))}))):(e.onRestoreFailed(),n.reject("customer disconnected, conversation ended"))})).fail((function(t){e.onRestoreFailed(t),n.reject("failed to retrieve conversation state")}))),n.promise())}},{key:"endChat",value:function(){var e=i.default.Deferred(),t=this.oSessionData,n=t.conversationId,o=t.memberId,s=this;return this.bSessionActive?(c.default.request({timeout:12e3,crossDomain:!0,contentType:"application/json; charset=utf-8",cache:!1,headers:{Authorization:"Bearer "+s.oSessionData.jwt},type:"DELETE",url:d.CreateUrl("/api/v2/webchat/guest/conversations/"+n+"/members/"+o),success:function(e){setTimeout((function(){s.bSessionActive||d.terminateChatSession()}),500)}}).always((function(t,n,o){var a=o||t;if(a){var r=a.status,i=a.responseText;!r||204!=r&&200!=r?(s.onError({code:r||"",message:i&&i.message?i.message:""}),e.reject(a)):(s.bSessionActive&&s.onChatEnded(a),e.resolve(a))}else s.onError(),e.reject(a);d.terminateChatSession()})),e.promise()):(e.reject("There is no active chat session"),s.onChatEnded(),d.terminateChatSession(),e.promise())}},{key:"updateUserData",value:function(){return i.default.Deferred().reject("This transport doesn't support updating userData during an active chat session.").promise()}},{key:"updateInteractionData",value:function(){return i.default.Deferred().reject("This transport doesn't support updating interactionData during an active chat session.").promise()}}]),e}();CXBus.registerModule("pure-cloud-v2-sockets-transport",m)}},["./webapp/plugins/cx-webchat-service/transports/pure-cloud-v2-sockets-transport.js"]);